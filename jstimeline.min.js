/*!
 * VERSION: 0.1.0
 * DATE: 2015-11-10
 * GIT:https://github.com/shrekshrek/jstimeline
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(e){var i="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["jstween","exports"],function(t,n){i.JTL=e(i,n,t)});else if("undefined"!=typeof exports){var t=require("jstween");e(i,exports,t)}else i.JTL=e(i,{},i.JT)}(function(e,i,t){function n(e,i){for(var t in i)e[t]=i[t]}function s(){l=!0;var e=o.length;if(0===e)return void(l=!1);for(var i=t.now(),n=e-1;n>=0;n--)o[n]._update(i);h(s)}function a(){this.initialize.apply(this,arguments)}var r=e.JTL;i.VERSION="0.1.0",i.noConflict=function(){return e.JTL=r,this};var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,o=[],l=!1;return n(a.prototype,{initialize:function(){this.labels=[],this.labelTime=0,this.anchors=[],this.anchorId=0,this.tweens=[],this.isPlaying=!1,this.curTime=0,this.lastTime=t.now()},_update:function(e){var i=e-this.lastTime;return this.lastTime=e,this.isPlaying?(this.curTime+=i,void this._checkHandler()):!0},_addSelf:function(){o.unshift(this),l?this._update(this.lastTime):s()},_removeSelf:function(){var e=o.indexOf(this);-1!==e&&o.splice(e,1)},_checkHandler:function(){var e=this.anchors.length;if(!(this.anchorId>=e)){var i=this.anchors[this.anchorId];this.curTime>=i.time&&(this.anchorId==e-1?(this._removeSelf(),this.isPlaying=!1,i.handler.apply()):(i.handler.apply(),this.anchorId++,this._checkHandler()))}},_parseTweenTime:function(e,i,t){var n=1e3*Math.max(e,0),s=1e3*Math.max(i.delay||0,0),a=Math.max(0,Math.floor(i.repeat||0)),r=1e3*Math.max(i.repeatDelay||0,0),h=s+(r+n)*(a+1),o=this._parsePosition(t);return this.labelTime=Math.max(this.labelTime,o+h),o},_parsePosition:function(e){if(void 0==e)return this.labelTime;var i=0;switch(typeof e){case"string":var t=e.substr(0,2),n=parseInt(1e3*parseFloat(e.substr(2)));switch(t){case"+=":i=this.labelTime+n;break;case"-=":i=this.labelTime-n;break;default:i=this.getLabelTime(e)}break;case"number":i=e}return i},_addAnchor:function(e,i){var t=this.anchors.length;if(0==t)return void this.anchors.push({time:i,handler:e});if(t>0)for(var n=t-1;n>=0;n--){var s=this.anchors[n];if(i>=s.time)return void this.anchors.splice(n+1,0,{time:i,handler:e})}},_addTween:function(e){this.tweens.unshift(e)},_removeTween:function(e){var i=this.tweens.indexOf(e);-1!==i&&this.tweens.splice(i,1)},fromTo:function(e,i,n,s,a){var r=this,h=s.onEnd;s.onEnd=function(e){r._removeTween(this),h&&h.apply(this,e)};var o=function(){var a=t.fromTo(e,i,n,s);r._addTween(a)},l=this._parseTweenTime(i,s,a);return this._addAnchor(o,l),this},from:function(e,i,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=t.from(e,i,n);a._addTween(s)},o=this._parseTweenTime(i,n,s);return this._addAnchor(h,o),this},to:function(e,i,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=t.to(e,i,n);a._addTween(s)},o=this._parseTweenTime(i,n,s);return this._addAnchor(h,o),this},kill:function(e,i){var n=function(){t.kill(e)},s=this._parseTweenTime(0,{},i);return this._addAnchor(n,s),this},add:function(e,i){var t=this._parsePosition(i);switch(typeof e){case"function":this._addAnchor(e,t);break;case"string":this.addLabel(e,t);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);return this.labels.push({name:e,time:t}),this},removeLabel:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return this.labels.splice(t,1),this}return this},getLabelTime:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return n.time}},totalTime:function(){return this.labelTime},play:function(e){if(!this.isPlaying){for(var i=this.tweens.length,n=i-1;n>=0;n--)this.tweens[n].play();this._addSelf(),this.isPlaying=!0,this.lastTime=t.now(),void 0!==e&&(this.seek(e),this._update(this.lastTime))}},pause:function(){if(this.isPlaying){for(var e=this.tweens.length,i=e-1;i>=0;i--)this.tweens[i].pause();this._removeSelf(),this.isPlaying=!1}},seek:function(e){var i=this._parsePosition(e);this.curTime=i;for(var t=this.anchors.length,n=0;t>n;n++){var s=this.anchors[n];if(s.time>=this.curTime)return void(this.anchorId=n)}},clear:function(){this.labels=[],this.anchors=[]},destroy:function(){this.pause(),this.clear()}}),n(i,{create:function(){return new a},kill:function(e){e.destroy()}}),i});
