/*!
 * VERSION: 0.1.0
 * DATE: 2015-11-10
 * GIT:https://github.com/shrekshrek/jstimeline
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(e){var i="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["jstween","exports"],function(t,n){i.JTL=e(i,n,t)});else if("undefined"!=typeof exports){var t=require("jstween");e(i,exports,t)}else i.JTL=e(i,{},i.JT)}(function(e,i,t){function n(e,i){for(var t in i)e[t]=i[t]}function s(){o=!0;var e=l.length;if(0===e)return void(o=!1);for(var i=t.now(),n=e-1;n>=0;n--)l[n]._update(i);h(s)}function a(){this.initialize.apply(this,arguments)}var r=e.JTL;i.VERSION="0.1.0",i.noConflict=function(){return e.JTL=r,this};var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,l=[],o=!1;return n(a.prototype,{initialize:function(){this.labels=[],this.labelTime=0,this.handlers=[],this.handlerId=0,this.isPlaying=!1,this.curTime=0,this.lastTime=t.now()},_update:function(e){var i=e-this.lastTime;return this.lastTime=e,this.isPlaying?(this.curTime+=i,void this._checkHandler()):!0},_addSelf:function(){l.unshift(this),o?this._update(this.lastTime):s()},_removeSelf:function(){var e=l.indexOf(this);-1!==e&&l.splice(e,1)},_checkHandler:function(){var e=this.handlers.length;if(!(this.handlerId>=e)){var i=this.handlers[this.handlerId];this.curTime>=i.time&&(this.handlerId==e-1?(this.pause(),i.handler.apply()):(i.handler.apply(),this.handlerId++,this._checkHandler()))}},_parseTweenTime:function(e,i,t){var n=1e3*Math.max(e,0),s=1e3*Math.max(i.delay||0,0),a=Math.max(0,Math.floor(i.repeat||0)),r=1e3*Math.max(i.repeatDelay||0,0),h=s+(r+n)*(a+1),l=this._parsePosition(t);return this.labelTime=Math.max(this.labelTime,l+h),l},_parsePosition:function(e){if(void 0==e)return this.labelTime;var i=0;switch(typeof e){case"string":var t=e.substr(0,2),n=parseInt(1e3*parseFloat(e.substr(2)));switch(t){case"+=":i=this.labelTime+n;break;case"-=":i=this.labelTime-n;break;default:i=this.getLabelTime(e)}break;case"number":i=e}return i},_add:function(e,i){var t=this.handlers.length;if(0==t)return void this.handlers.push({time:i,handler:e});if(t>0)for(var n=t-1;n>=0;n--){var s=this.handlers[n];if(i>=s.time)return void this.handlers.splice(n+1,0,{time:i,handler:e})}},fromTo:function(e,i,n,s,a){var r=function(){t.fromTo(e,i,n,s)},h=this._parseTweenTime(i,s,a);return this._add(r,h),this},from:function(e,i,n,s){var a=function(){t.from(e,i,n)},r=this._parseTweenTime(i,n,s);return this._add(a,r),this},to:function(e,i,n,s){var a=function(){t.to(e,i,n)},r=this._parseTweenTime(i,n,s);return this._add(a,r),this},add:function(e,i){var t=this._parsePosition(i);switch(typeof e){case"function":this._add(e,t);break;case"string":this.addLabel(e,t);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);return this.labels.push({name:e,time:t}),this},removeLabel:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return this.labels.splice(t,1),this}return this},getLabelTime:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return n.time}},totalTime:function(){return this.labelTime},play:function(e){this.isPlaying||(this._addSelf(),this.isPlaying=!0,this.lastTime=t.now(),void 0!==e&&(this.seek(e),this._update(this.lastTime)))},pause:function(){this.isPlaying&&(this._removeSelf(),this.isPlaying=!1)},seek:function(e){var i=this._parsePosition(e);this.curTime=i;for(var t=this.handlers.length,n=0;t>n;n++){var s=this.handlers[n];if(s.time>=this.curTime)return void(this.handlerId=n)}},clear:function(){this.labels=[],this.handlers=[]},kill:function(){this.pause(),this.clear()}}),n(i,{create:function(){return new a},kill:function(e){e.kill()}}),i});
