/*!
 * VERSION: 0.1.0
 * DATE: 2015-11-10
 * GIT:https://github.com/shrekshrek/jstimeline
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(e){var i="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["jstween","exports"],function(t,s){i.JTL=e(i,s,t)});else if("undefined"!=typeof exports){var t=require("jstween");e(i,exports,t)}else i.JTL=e(i,{},i.JT)}(function(e,i,t){function s(e,i){for(var t in i)e[t]=i[t]}function n(){o=!0;var e=l.length;if(0===e)return void(o=!1);for(var i=t.now(),s=e-1;s>=0;s--)l[s].update(i);h(n)}function a(){this.initialize.apply(this,arguments)}var r=e.JTL;i.VERSION="0.1.0",i.noConflict=function(){return e.JTL=r,this};var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,l=[],o=!1;return s(a.prototype,{initialize:function(){this.labels=[],this.labelTime=0,this.handlers=[],this.handlerId=0,this.isRemove=!0,this.isPlaying=!1,this.curTime=0,this.lastTime=t.now()},update:function(e){var i=e-this.lastTime;return this.lastTime=e,this.isPlaying?(this.curTime+=i,void this._checkHandler()):!0},_addSelf:function(){l.unshift(this),o?this.update(this.lastTime):n()},_removeSelf:function(){var e=l.indexOf(this);-1!==e&&l.splice(e,1)},_checkHandler:function(){var e=this.handlers[this.handlerId];return void 0==e?(this._removeSelf(),this.isRemove=!0,void(this.isPlaying=!1)):void(this.curTime>=this.handlers[this.handlerId].time&&(this.handlers[this.handlerId].handler.apply(),this.handlerId++,this._checkHandler()))},_parseTweenTime:function(e,i,t){var s=1e3*Math.max(e,0),n=1e3*Math.max(i.delay||0,0),a=Math.max(0,Math.floor(i.repeat||0)),r=1e3*Math.max(i.repeatDelay||0,0),h=n+(r+s)*(a+1),l=this._parsePosition(t);return this.labelTime=Math.max(this.labelTime,l+h),l},_parsePosition:function(e){if(void 0==e)return this.labelTime;var i=0;switch(typeof e){case"string":var t=e.substr(0,2),s=parseInt(1e3*parseFloat(e.substr(2)));switch(t){case"+=":i=this.labelTime+s;break;case"-=":i=this.labelTime-s;break;default:i=this.getLabelTime(e)}break;case"number":i=e}return i},_add:function(e,i){var t=this.handlers.length;if(0==t)return void this.handlers.push({time:i,handler:e});if(t>0)for(var s=t-1;s>=0;s--){var n=this.handlers[s];if(i>=n.time)return void this.handlers.splice(s+1,0,{time:i,handler:e})}},fromTo:function(e,i,s,n,a){var r=function(){t.fromTo(e,i,s,n)},h=this._parseTweenTime(i,n,a);return this._add(r,h),this},from:function(e,i,s,n){var a=function(){t.from(e,i,s)},r=this._parseTweenTime(i,s,n);return this._add(a,r),this},to:function(e,i,s,n){var a=function(){t.to(e,i,s)},r=this._parseTweenTime(i,s,n);return this._add(a,r),this},add:function(e,i){var t=this._parsePosition(i);switch(typeof e){case"function":this._add(e,t);break;case"string":this.addLabel(e,t);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);return this.labels.push({name:e,time:t}),this},removeLabel:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var s=this.labels[t];if(e==s.name)return this.labels.splice(t,1),this}return this},getLabelTime:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var s=this.labels[t];if(e==s.name)return s.time}},totalTime:function(){return this.labelTime},play:function(e){this.isRemove&&(this.lastTime=t.now(),this.isRemove=!1,this._addSelf()),this.isPlaying=!0,void 0!==e&&(this.seek(e),this.update(this.lastTime))},pause:function(){this.isPlaying=!1},seek:function(e){var i=this._parsePosition(e);this.curTime=i;for(var t=this.handlers.length,s=0;t>s;s++){var n=this.handlers[s];if(n.time>=this.curTime)return void(this.handlerId=s)}},clear:function(){this.labels=[],this.handlers=[]},kill:function(){this._removeSelf(),this.clear()}}),s(i,{create:function(){return new a},kill:function(e){var i=l.indexOf(e);-1!==i&&l.splice(i,1),e.clear()}}),i});
